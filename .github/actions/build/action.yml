name: Build Docker image

description: Build a Docker image, scan it with Wiz, and push it to GitHub Container Registry

inputs:
  version:
    required: true
    type: string
  latest:
    required: false
    type: boolean
    default: false
  github-token:
    required: true
    type: string
  dockerfile-path:
    required: true
    type: string
  docker-image-name:
    required: true
    type: string
  wiz-client-id:
    required: true
    type: string
  wiz-client-secret:
    required: true
    type: string
  wiz-project-id:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    # - name: Disable Wiz scanning
    #   run: echo "DISABLE_WIZ=true" >> $GITHUB_ENV
    #   shell: bash

    - name: Log in to registry
      run: echo "${{ inputs.github-token }}" | docker login ghcr.io -u $ --password-stdin
      shell: bash

    - name: Install Wiz CLI
      uses: nationalarchives/ds-docker-actions/.github/actions/wiz-install-cli@main

    - name: Add Wiz CLI to .dockerignore
      run: |
        echo "" >> .dockerignore
        echo "wizcli" >> .dockerignore
      shell: bash

    - name: Set up Docker image name
      id: docker-image-name
      run: |
        IMAGE_NAME=$(echo "ghcr.io/${{ github.repository_owner }}/${{ inputs.docker-image-name }}" | tr '[A-Z]' '[a-z]')
        echo $IMAGE_NAME
        echo "IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_ENV"
      shell: bash

    - name: Lint Dockerfile
      uses: nationalarchives/ds-docker-actions/.github/actions/lint@main
      with:
        dockerfile-path: ${{ inputs.dockerfile-path }}
        # DL3045 (https://github.com/hadolint/hadolint/wiki/DL3045) - WORKDIR is set on the base image but not in the application images
        # DL3007 (https://github.com/hadolint/hadolint/wiki/DL3007) - We only use "latest" for our own images
        # DL3059 (https://github.com/hadolint/hadolint/wiki/DL3059) - This is only a suggestion
        ignore-linting-rules: DL3045,DL3007,DL3059

    - name: Scan Dockerfile
      uses: nationalarchives/ds-docker-actions/.github/actions/wiz-scan-dockerfile@main
      with:
        image-id: ${{ env.IMAGE_NAME }}
        image-tag: ${{ inputs.version }}
        dockerfile-path: ${{ inputs.dockerfile-path }}
        wiz-client-id: ${{ inputs.wiz-client-id }}
        wiz-client-secret: ${{ inputs.wiz-client-secret }}
        wiz-project-id: ${{ inputs.wiz-project-id }}

    - name: Build image
      run: |
        docker build --tag ${{ inputs.docker-image-name }}:${{ inputs.version }} --build-arg "BUILD_VERSION=${{ inputs.version }}" --build-arg "CONTAINER_IMAGE=${{ env.IMAGE_NAME }}" --platform linux/amd64 --no-cache .
        docker inspect ${{ inputs.docker-image-name }}:${{ inputs.version }}
        docker images --digests
      shell: bash

    - name: Scan container
      uses: nationalarchives/ds-docker-actions/.github/actions/wiz-scan-container@main
      with:
        image-id: ${{ inputs.docker-image-name }}
        image-tag: ${{ inputs.version }}
        dockerfile-path: ${{ inputs.dockerfile-path }}
        wiz-client-id: ${{ inputs.wiz-client-id }}
        wiz-client-secret: ${{ inputs.wiz-client-secret }}
        wiz-project-id: ${{ inputs.wiz-project-id }}

    - name: Tag and push image
      run: |
        docker tag ${{ inputs.docker-image-name }}:${{ inputs.version }} ${{ env.IMAGE_NAME }}:${{ inputs.version }}
        docker push ${{ env.IMAGE_NAME }}:${{ inputs.version }}
      shell: bash

    - name: Tag latest
      if: ${{ inputs.latest == 'true' }}
      run: |
        docker tag ${{ inputs.docker-image-name }}:${{ inputs.version }} ${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.IMAGE_NAME }}:latest
      shell: bash

    - name: Tag container
      uses: nationalarchives/ds-docker-actions/.github/actions/wiz-tag-container@main
      with:
        image-id: ${{ env.IMAGE_NAME }}
        image-tag: ${{ inputs.version }}
        wiz-client-id: ${{ inputs.wiz-client-id }}
        wiz-client-secret: ${{ inputs.wiz-client-secret }}
        wiz-project-id: ${{ inputs.wiz-project-id }}
