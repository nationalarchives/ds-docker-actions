name: Build Docker image (v2)

inputs:
  version:
    required: true
    type: string
  latest:
    required: false
    type: boolean
    default: false
  github-token:
    required: true
    type: string
  docker-image-name:
    required: true
    type: string
  wiz-client-id:
    required: true
    type: string
  wiz-client-secret:
    required: true
    type: string
  wiz-project-id:
    required: true
    type: string

env:
  DISABLE_WIZ: true  # TODO: Remove this when Wiz is fixed

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: Log in to registry
      run: echo "${{ inputs.github-token }}" | docker login ghcr.io -u $ --password-stdin
      shell: bash

    - name: Set up Wiz
      uses: nationalarchives/ds-docker-actions/.github/actions/setup-wiz@main
      with:
        wiz-client-id: ${{ inputs.wiz-client-id }}
        wiz-client-secret: ${{ inputs.wiz-client-secret }}

    - name: Set up Docker image name
      id: docker-image-name
      run: |
        IMAGE_NAME=$(echo "ghcr.io/${{ github.repository_owner }}/${{ inputs.docker-image-name }}" | tr '[A-Z]' '[a-z]')
        echo $IMAGE_NAME
        echo "IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_ENV"
      shell: bash

    - name: Lint Dockerfile
      uses: nationalarchives/ds-docker-actions/.github/actions/lint@main
      with:
        dockerfile-path: .
        ignore-linting-rules: DL3045,DL3007
        wiz-project-id: ${{ inputs.wiz-project-id }}

    - name: Scan Dockerfile
      uses: nationalarchives/ds-docker-actions/.github/actions/scan-dockerfile@main
      with:
        image-id: ${{ env.IMAGE_NAME }}
        image-tag: ${{ inputs.version }}
        dockerfile-path: .
        wiz-project-id: ${{ inputs.wiz-project-id }}

    - name: Build and push image
      run: |
        docker build --tag ${{ env.IMAGE_NAME }}:${{ inputs.version }} --build-arg "BUILD_VERSION=${{ inputs.version }}" --platform linux/amd64 --no-cache .
        docker push ${{ env.IMAGE_NAME }}:${{ inputs.version }}
      shell: bash

    - name: Tag latest
      if: ${{ inputs.latest == 'true' }}
      run: |
        docker tag ${{ env.IMAGE_NAME }}:${{ inputs.version }} ${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.IMAGE_NAME }}:latest
      shell: bash

    - name: Scan container
      uses: nationalarchives/ds-docker-actions/.github/actions/scan-container@main
      with:
        image-id: ${{ env.IMAGE_NAME }}
        image-tag: ${{ inputs.version }}
        wiz-project-id: ${{ inputs.wiz-project-id }}
